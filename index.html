<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <link
            rel="stylesheet"
            href="./css-files/Index.css"
        />
        <link
            rel="shortcut icon"
            href="./assets/favicon.png"
            type="image/x-icon"
        />
        <title>Level Up Dev</title>
    </head>
    <body>
        <div class="App">
            <div class="navbar">
                <a href="/">
                    <img
                        class="logo"
                        src="./assets/logo.jpg" id = "./Home.html"
                    />
                </a>

                <div
                    class="menu"
                    id="nav-menu"
                >
                    <a
                        class="nav-link active"
                        id="./Home.html"
                        >Home</a
                    >
                    <a
                        class="nav-link"
                        id="./Tasks.html"
                        >Practice</a
                    >
                    <a
                        class="nav-link"
                        id="./Compiler.html"
                        >Compiler</a
                    >
                    <a
                        class="nav-link"
                        id="./ContactUs.html"
                        >Contact Us</a
                    >
                    <a
                        class="nav-link"
                        id="./login.html"
                    ></a>
                    <div id="profile-menu">
                        <a class="./Profile.html">My Account</a>
                        <a class="./favourites.html">My Favourites</a>
                        <a onclick="logout()">Log Out</a>
                    </div>
                </div>
            </div>

            <div class="mobile-nav">
                <a href="/">
                    <img
                        class="logo"
                        src="./assets/logo.jpg"
                    />
                </a>

                <div
                    class="hamburger"
                    onclick="toggleMenu()"
                >
                    &#9776;
                </div>

                <div
                    class="menu"
                    id="mob-nav-menu"
                >
                    <a
                        class="nav-link active"
                        id="./Home.html"
                        >Home</a
                    >
                    <a
                        class="nav-link"
                        id="./Tasks.html"
                        >Practice</a
                    >
                    <a
                        class="nav-link"
                        id="./Compiler.html"
                        >Compiler</a
                    >
                    <a
                        class="nav-link"
                        id="./ContactUs.html"
                        >Contact Us</a
                    >
                    <a
                        class="nav-link login"
                        id="./login.html"
                        >Sign in</a
                    >
                    <a
                        class="nav-link hide"
                        id="./Profile.html"
                        >My Account</a
                    >
                    <a
                        class="nav-link hide"
                        id="./favourites.html"
                        >My Favourites</a
                    >
                    <a
                        class="nav-link hide"
                        id="logout"
                        onclick="logout()"
                        >Logout</a
                    >
                </div>
            </div>

            <iframe
                src="./Home.html"
                frameborder="0"
            ></iframe>
        </div>
        <button id="chat-toggle">
            <img
                src="./assets/robo.jpg"
                alt=""
            />
        </button>
        <div
            id="chat-popup"
            class="chat-popup"
            style="display: none"
        >
            <div class="chat-header">AI Chatbot</div>
            <div
                id="chat-box"
                class="chat-box"
            ></div>
            <div class="input-area">
                <input
                    id="user-input"
                    placeholder="Say something..."
                    onkeydown="if(event.key==='Enter') sendMessage()"
                />
                <button
                    class="send-btn"
                    onclick="sendMessage()"
                >
                    Send
                </button>
            </div>
        </div>
        <script>
            window.addEventListener("resize", function () {
                document.getElementsByTagName("iframe")[0].style.height =
                    window.innerHeight - 80 + "px";
                document.getElementsByTagName("iframe")[0].style.width =
                    window.innerWidth + "px";
                document.getElementsByClassName("mobile-nav")[0].style.width =
                    window.innerWidth + "px";
            });

            localStorage.setItem("total-count", 0);
            localStorage.setItem("easy-count", 0);
            localStorage.setItem("med-count", 0);
            localStorage.setItem("hard-count", 0);
            localStorage.setItem("last-submitted", "");
            localStorage.setItem("fav-task1", -1);
            localStorage.setItem("fav-task2", -1);
            localStorage.setItem("fav-task3", -1);
            localStorage.setItem("fav-task4", -1);
            localStorage.setItem("fav-task5", -1);
            localStorage.setItem("fav-task6", -1);
            localStorage.setItem("fav-task7", -1);
            localStorage.setItem("fav-task8", -1);
            localStorage.setItem("fav-task9", -1);
            localStorage.setItem("task_page", -1);
            const navLinks = document.querySelectorAll(".nav-link");

            navLinks.forEach((link) => {
                link.addEventListener("click", function () {
                    links.forEach((l) => l.classList.remove("active"));
                    this.classList.add("active");
                });
            });

            const links = document.querySelectorAll(".menu > a");
            links.forEach((link) => {
                link.addEventListener("click", function (event) {
                    const target = this.getAttribute("id");
                    if (
                        (target === "./login.html" &&
                        localStorage.getItem("loggedInUserName")) ||
                        target === 'logout'
                    )
                        return;
                    else document.querySelector("iframe").src = target;
                });
            });

            const profileLinks = document.querySelectorAll("#profile-menu a");
            profileLinks.forEach((opt) => {
                opt.addEventListener("click", function (event) {
                    const target = this.getAttribute("class");
                    document.querySelector("iframe").src = target;
                    const proMenu = document.getElementById("profile-menu");
                    proMenu.style.display = "none";
                });
            });

            for (let i = 0; i < 9; i++) {
                if (!localStorage.getItem(`task${i}`))
                    localStorage.setItem(`task${i}`, false);
            }

            const loginLink = document.getElementById("./login.html");
            const name = localStorage.getItem("loggedInUserName");
            const firstName =
                name && name.trim() ? name.trim().split(" ")[0] : null;

            loginLink.innerHTML = firstName
                ? `<svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#e3e3e3"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>`
                : "Sign in";

            loginLink.addEventListener("click", function () {
                if (name) {
                    const proMenu = document.getElementById("profile-menu");
                    proMenu.style.display =
                        proMenu.style.display === "flex" ? "none" : "flex";
                }
            });

            function logout() {
                localStorage.clear();
                window.location.reload();
            }

            const API_KEY = "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";
            const chatToggleBtn = document.getElementById("chat-toggle");
            const chatPopup = document.getElementById("chat-popup");
            const chatBox = document.getElementById("chat-box");
            const userInput = document.getElementById("user-input");

            const chatHistory = [];

            chatToggleBtn.onclick = () => {
                chatPopup.style.display =
                    chatPopup.style.display === "none" ? "flex" : "none";
            };

            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                appendMessage("user", message);
                chatHistory.push({ sender: "user", text: message });
                userInput.value = "";

                try {
                    const body = {
                        model: "mistralai/mistral-7b-instruct",
                        messages: [
                            ...chatHistory.map((msg) => ({
                                role:
                                    msg.sender === "user"
                                        ? "user"
                                        : "assistant",
                                content: msg.text,
                            })),
                            { role: "user", content: message },
                        ],
                    };

                    const response = await fetch(
                        "https://openrouter.ai/api/v1/chat/completions",
                        {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${API_KEY}`,
                                "Content-Type": "application/json",
                                "HTTP-Referer": window.location.origin,
                                "X-Title": "PopupChatBot",
                            },
                            body: JSON.stringify(body),
                        }
                    );

                    const data = await response.json();
                    const reply =
                        data.choices?.[0]?.message?.content || "No response.";
                    appendMessage("bot", reply);
                    chatHistory.push({ sender: "bot", text: reply });
                } catch (error) {
                    console.error("Error:", error);
                    appendMessage(
                        "bot",
                        "❌ Error: Could not reach AI service."
                    );
                    chatHistory.push({
                        sender: "bot",
                        text: "❌ Error: Could not reach AI service.",
                    });
                }
            }

            function appendMessage(sender, text) {
                const msgDiv = document.createElement("div");
                msgDiv.className = `message ${sender}`;
                const bubble = document.createElement("div");
                bubble.className = "bubble";
                bubble.textContent = text;
                msgDiv.appendChild(bubble);
                chatBox.appendChild(msgDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function toggleMenu() {
                const menu = document.getElementById("mob-nav-menu");
                menu.classList.toggle("show");
            }

            document.querySelectorAll(".menu a").forEach((link) => {
                link.addEventListener("click", () => {
                    document
                        .getElementById("nav-menu")
                        .classList.remove("show");
                    const menu = document.getElementById("mob-nav-menu");
                    menu.classList.toggle("show");
                });
            });

            window.addEventListener("DOMContentLoaded", function () {
                if (localStorage.getItem("loggedInUserName")) {
                    document
                        .getElementsByClassName("login")[0]
                        .classList.add("hide");
                    document
                        .getElementById("./Profile.html")
                        .classList.remove("hide");
                    document
                        .getElementById("./favourites.html")
                        .classList.remove("hide");
                    document.getElementById("logout").classList.remove("hide");
                }
            });
        </script>
    </body>
</html>
